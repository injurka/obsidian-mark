В этом разделе мы рассмотрим поддержку SCSI в ядре Linux. Если вы торопитесь, можете перейти к главе 4, так как этот материал более продвинутого уровня и имеет менее практический характер.

## Предыстория SCSI

Традиционная настройка оборудования SCSI включает адаптер хоста, связанный с цепочкой устройств по шине SCSI. Адаптер хоста подключается к компьютеру, и каждое устройство имеет идентификатор SCSI ID. Шина может поддерживать 8 или 16 идентификаторов в зависимости от версии SCSI.

## Взаимодействие устройств

Компьютер взаимодействует с дисками и другими устройствами через адаптер хоста, отправляя команды SCSI и получая ответы через него.

## Современные версии SCSI

Serial Attached SCSI (SAS) обеспечивает высокую производительность, но реальные устройства SCSI встречаются редко. USB-накопители и устройства ATAPI (например, приводы CD/DVD-ROM) часто используют команды SCSI.

> Шина SCSI с хост-адаптером и устройствами

![[./_/scsi.png]]

## Диски SATA

Диски SATA отображаются в системе как устройства SCSI, но взаимодействуют через уровень трансляции в библиотеке libata.

## Пример системы

Рассмотрим устройства в следующей системе:

```bash
$ lsscsi
[0:0:0:0] disk ATA WDC WD3200AAJS-2 01.0 /dev/sda
[1:0:0:0] cd/dvd Slimtype DVD A DS8A5SH XA15 /dev/sr0
[2:0:0:0] disk USB2.0 CardReader CF 0100 /dev/sdb
[2:0:0:1] disk USB2.0 CardReader SM XD 0100 /dev/sdc
[2:0:0:2] disk USB2.0 CardReader MS 0100 /dev/sdd
[2:0:0:3] disk USB2.0 CardReader SD 0100 /dev/sde
[3:0:0:0] disk FLASH Drive UT_USB20 0.00 /dev/sdf
```

Цифры в квадратных скобках обозначают номер адаптера хоста SCSI, номер шины SCSI, идентификатор SCSI-устройства и LUN (Logical Unit Number). В примере четыре адаптера (scsi0, scsi1, scsi2 и scsi3), каждый с одной шиной и одним устройством на каждой шине. Считыватель USB-карт имеет четыре логических блока, каждому из которых назначен отдельный файл устройства.


--
--
--
--



## Предыстория SCSI

Традиционная настройка оборудования SCSI включает адаптер хоста, связанный с цепочкой устройств по шине SCSI. Адаптер хоста подключается к компьютеру, и каждое устройство имеет идентификатор SCSI ID. Шина может поддерживать 8 или 16 идентификаторов в зависимости от версии SCSI.

## Взаимодействие устройств

Компьютер взаимодействует с дисками и другими устройствами через адаптер хоста, отправляя команды SCSI и получая ответы через него.

## Современные версии SCSI

Serial Attached SCSI (SAS) обеспечивает высокую производительность, но реальные устройства SCSI встречаются редко. USB-накопители и устройства ATAPI (например, приводы CD/DVD-ROM) часто используют команды SCSI.

## Диски SATA

Диски SATA отображаются в системе как устройства SCSI, но взаимодействуют через уровень трансляции в библиотеке libata.

## Пример системы

Рассмотрим устройства в следующей системе:

```bash
$ lsscsi
[0:0:0:0] disk ATA WDC WD3200AAJS-2 01.0 /dev/sda
[1:0:0:0] cd/dvd Slimtype DVD A DS8A5SH XA15 /dev/sr0
[2:0:0:0] disk USB2.0 CardReader CF 0100 /dev/sdb
[2:0:0:1] disk USB2.0 CardReader SM XD 0100 /dev/sdc
[2:0:0:2] disk USB2.0 CardReader MS 0100 /dev/sdd
[2:0:0:3] disk USB2.0 CardReader SD 0100 /dev/sde
[3:0:0:0] disk FLASH Drive UT_USB20 0.00 /dev/sdf
```

Цифры в квадратных скобках обозначают номер адаптера хоста SCSI, номер шины SCSI, идентификатор SCSI-устройства и LUN (Logical Unit Number). В примере четыре адаптера (scsi0, scsi1, scsi2 и scsi3), каждый с одной шиной и одним устройством на каждой шине. Считыватель USB-карт имеет четыре логических блока, каждому из которых назначен отдельный файл устройства.

## Иерархия драйверов SCSI

На рисунке показана иерархия драйверов и интерфейсов внутри ядра для конкретной конфигурации системы, начиная с отдельных драйверов устройств и заканчивая драйверами блоков. Она не включает в себя обобщенные драйверы SCSI generic (sg).

![[./_/scsi-1.png]]


### Уровни драйверов SCSI

1. **Верхний уровень**: Обрабатывает операции для класса устройств. Например, драйвер sd (SCSI disk) переводит запросы из интерфейса устройства блока ядра в команды для конкретного диска в протоколе SCSI.
2. **Средний уровень**: Модерирует и направляет сообщения SCSI между верхним и нижним уровнями, а также отслеживает все шины SCSI и устройства, подключенные к системе.
3. **Нижний уровень**: Обрабатывает действия, зависящие от оборудования. Драйверы здесь отправляют исходящие сообщения протокола SCSI определенным адаптерам хоста или оборудованию и принимают входящие сообщения из оборудования.

## USB-накопитель и SCSI

Для взаимодействия подсистемы SCSI с обычными USB-накопителями ядру требуется нечто большее, чем просто драйвер SCSI нижнего уровня. Флеш-накопитель USB, представленный файлом /dev/sdf, понимает команды SCSI, но для взаимодействия с накопителем ядро должно знать, как общаться через систему USB.

### Подсистема USB

Система USB очень похожа на систему SCSI — у нее есть классы устройств, шины и контроллеры хостов. Поэтому ядро Linux включает в себя трехуровневую подсистему USB, с драйверами класса устройств вверху, ядром управления шиной посередине и драйверами хост-контроллера внизу.

### Драйвер USB-накопителя

Драйвер USB-накопителя выступает в роли переводчика. На одном конце драйвер говорит на «языке» SCSI, а на другом — на «языке» USB. Он переупаковывает данные, чтобы подсистемы SCSI и USB могли взаимодействовать.

## Интерфейсы SCSI и ATA

Жесткий диск SATA и оптический привод работают с одним и тем же интерфейсом SATA. Для подключения специфичных для SATA драйверов ядра к подсистеме SCSI ядро использует драйвер-мост, как и в случае с USB-накопителями, но с другим механизмом и дополнительными сложностями.

### Библиотека libata

Ядро Linux использует часть библиотеки libata для согласования дисков SATA (и ATA) с подсистемой SCSI. Для оптических приводов, говорящих на языке ATAPI, упаковка команд SCSI в протокол ATA и извлечение из него — это относительно простая задача. Но для жесткого диска задача намного усложняется, потому что библиотека должна выполнить полный перевод команд.

## Обобщенные устройства SCSI

Когда процесс пользовательского пространства взаимодействует с подсистемой SCSI, он обычно выполняет задачу через уровень блочных устройств и/или другую службу ядра, которая находится поверх драйвера класса устройств SCSI (например, sd или sr). Однако пользовательские процессы могут обходить драйверы классов устройств и передавать команды протокола SCSI непосредственно устройствам через их обобщенные устройства.

### Пример обобщенных устройств

```bash
$ lsscsi -g
[0:0:0:0] disk ATA WDC WD3200AAJS-2 01.0 /dev/sda /dev/sg0
[1:0:0:0] cd/dvd Slimtype DVD A DS8A5SH XA15 /dev/sr0 /dev/sg1
[2:0:0:0] disk USB2.0 CardReader CF 0100 /dev/sdb /dev/sg2
[2:0:0:1] disk USB2.0 CardReader SM XD 0100 /dev/sdc /dev/sg3
[2:0:0:2] disk USB2.0 CardReader MS 0100 /dev/sdd /dev/sg4
[2:0:0:3] disk USB2.0 CardReader SD 0100 /dev/sde /dev/sg5
[3:0:0:0] disk FLASH Drive UT_USB20 0.00 /dev/sdf /dev/sg6
```

В дополнение к обычному файлу блочного устройства каждая запись содержит обобщенный файл устройства SCSI в последнем столбце. Например, обобщенным устройством для оптического привода в /dev/sr0 является /dev/sg1.

### Зачем нужно обобщенное устройство

Это обусловлено сложностью кода ядра: когда задачи становятся особенно сложными, лучше их вывести за пределы ядра. Например, запись на оптический диск значительно сложнее, чем чтение, и никакие критические системные службы не зависят от действия записи. Поэтому для записи на оптический диск в Linux вы запускаете программу пользовательского пространства, которая взаимодействует с обобщенным устройством SCSI, таким как /dev/sg1.

## Методы множественного доступа к одному устройству

На рисунке показаны две точки доступа (sr и sg) для оптического привода из пространства пользователя для подсистемы SCSI Linux. Процесс A считывает данные с диска с помощью драйвера sr, а процесс Б записывает данные на диск с помощью драйвера sg. Однако подобные процессы обычно не запускаются одновременно для доступа к одному и тому же устройству.

![[./_/scsi-2.png]]



