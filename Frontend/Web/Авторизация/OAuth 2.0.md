---
dg-publish: true
---
Это открытый стандарт делегирования доступа, обычно используемый пользователями Интернета для предоставления веб-сайтам (клиентам) доступа к их информации на других веб-сайтах (серверах ресурсов), но без предоставления им паролей.
_OAuth2.0 — authorization_

Терминология:

1. Владелец ресурса — объект, который может предоставлять доступ к защищенному ресурсу. Обычно это конечный пользователь.

2. Клиент — приложение, запрашивающее доступ к защищенному ресурсу от имени Владельца ресурса.

3. Сервер авторизации — сервер, который аутентифицирует владельца ресурса и выдает токены доступа после получения надлежащей авторизации.

4. Сервер ресурсов — сервер, на котором размещены защищенные ресурсы. Это API, к которому вы хотите получить доступ.

5. URL перенаправления — URL, на который сервер авторизации перенаправляет пользователя после успешной авторизации клиента. Этот URL содержит конфиденциальную информацию.

6. URL—адрес аутентификации - URL-адрес сервера авторизации, по которому клиентское приложение запрашивает разрешение у владельца ресурса на доступ к информации, указанной в области видимости, с сервера ресурсов.

```
https://accounts.google.com/o/oauth2/v2/auth?redirect_uri=<YOUR_CALLBACK_URL_SET_ON_GOOGLE>&prompt=consent&response_type=code&client_id=<YOUR_CLIENT_ID>&scope=openid%20email%20profile&access_type=offline
```

7. URL—адрес токена доступа - URL-адрес, по которому клиентское приложение отправляет запрос post с кодом в качестве полезной нагрузки в обмен на токен доступа и идентификационный токен. Это используется в потоке кода авторизации.

8. Токен доступа — часть данных, представляющая авторизацию для доступа к ресурсам от имени конечного пользователя

9. Токен ID — это токен JWT, который включает утверждения, касающиеся аутентификации пользователя.

10. Scope — механизм в OAuth 2.0 для ограничения доступа приложения к учетной записи пользователя. Это означает, что токен доступа, выданный клиентскому приложению, будет ограничен предоставленными областями. В приведенном выше URL-адресе аутентификации область действия - OpenID, электронная почта, профиль

---

## Типы разрешений (потоки)

### Поток кода авторизации (передний канал + задний канал обратной связи)

Передний канал + задний канал обратной связи означает, что существует связь пользователя с клиентом (передний канал) и клиента с сервером социального провайдера (задний канал)

Это включает в себя обмен кода авторизации на токен.
![[./assets/oauth.png]]

1. Пользователь нажимает кнопку “Войти с помощью бла-бла-бла”, это может быть любой социальный провайдер, такой как Google, GitHub, Twitter или Facebook.

![[./assets/oauth_1.png]]

2. Клиент (наш веб-сайт) отправляет запрос на сервер авторизации социального провайдера. URL-адрес аутентификации содержит такие параметры запроса, как область действия, response_type, redirect_url и client_id

3. Сервер авторизации перенаправляет пользователя на запрос входа в систему и авторизации.

4. Пользователь аутентифицируется, используя один из настроенных параметров входа в систему, и может увидеть запрос на получение согласия с перечислением разрешений, которые сервер авторизации предоставит клиентскому приложению.

5. Сервер авторизации перенаправляет пользователя обратно в приложение с одноразовым кодом авторизации. Сервер авторизации передает код в качестве параметра запроса URI перенаправления.

6. Клиентское приложение отправляет код авторизации, идентификатор клиента приложения и учетные данные приложения, такие как секрет клиента или закрытый ключ JWT, на сервер авторизации посредством post-запроса.

7. Сервер авторизации проверяет код авторизации, идентификатор клиента приложения и учетные данные приложения.

8. Сервер авторизации выдает в ответ идентификационный токен и токен доступа (и, необязательно, токен обновления).

9. Приложение может использовать токен доступа для вызова API (сервера ресурсов) для доступа к информации о пользователе.

10. API отвечает запрошенными данными.


### Неявный поток (только для переднего канала)

Неявный поток предоставления предназначен для клиентских приложений, таких как веб-приложения, запущенные в браузере пользователя, где клиентское приложение не может надежно хранить учетные данные клиента. В этом потоке токен доступа возвращается непосредственно клиентскому приложению после того, как пользователь авторизует приложение. Затем клиентское приложение может использовать этот токен доступа для доступа к защищенным ресурсам от имени пользователя.

![[oauth_2.png]]


1. Пользователь нажимает "Войти" в приложении
2. Наше клиентское приложение перенаправляет пользователя на сервер авторизации, передавая параметр token `response_type`, который указывает тип запрашиваемых учетных данных.
3. Сервер авторизации перенаправляет пользователя на запрос входа и авторизации.
4. Пользователь проходит аутентификацию, используя один из настроенных параметров входа, и может запросить страницу согласия, на которой перечислены разрешения, которые сервер авторизации предоставит приложению.
5. Сервер авторизации перенаправляет пользователя обратно в приложение с помощью токена доступа.

Этот поток не так безопасен, как поток кода авторизации, поскольку токен доступа отправляется в браузер пользователя, который уязвим для кибератак, таких как межсайтовый скриптинг (XSS), в отличие от потока кода авторизации, где происходит обмен кодом и токеном доступа по обратному каналу.

Implicit flow поддерживает одностраничные приложения JavaScript, которым необходимо напрямую получать токены.

### Учетные данные клиента (только для обратного канала)

Поток учетных данных клиента включает в себя обмен клиентским приложением своих учетных данных приложения, таких как идентификатор клиента и секрет клиента, на токен доступа.

Этот поток лучше всего подходит для межмашинных приложений (M2M), таких как CLI, демоны или серверные службы, поскольку система должна проверять подлинность и авторизовать приложение, а не пользователя.

![[oauth_3.png]]

1. Клиентское приложение отправляет учетные данные приложения на сервер авторизации.
2. Сервер авторизации проверяет учетные данные приложения.
3. Сервер авторизации отвечает токеном доступа.
4. Клиентское приложение отправляет токен доступа при каждом последующем запросе к API (серверу ресурсов)
5. API отвечает запрошенными данными.

Если вы взаимодействовали с API Daraja от Mpesa, они используют этот тип гранта для аутентификации клиентских приложений.

### Учетные данные с паролем владельца ресурса (только для обратного канала)

При этом типе предоставления клиентские приложения запрашивают у пользователей их учетные данные (имя пользователя и пароль). Эти учетные данные обмениваются на токен доступа.

Это не рекомендуется, поскольку клиентское приложение может сохранить учетные данные пользователя в базе данных для использования в будущем.

![[oauth_4.png]]

1. Пользователь нажимает **Войти ** в приложении и вводит свои учетные данные.
2. Ваше приложение пересылает учетные данные пользователя на сервер авторизации
3. Сервер авторизации проверяет учетные данные.
4. Сервер авторизации отвечает токеном доступа (и, необязательно, токеном обновления).
5. Ваше приложение может использовать токен доступа для вызова API для доступа к информации о пользователе.
6. API отвечает запрошенными данными.

*Какой тип гранта (поток) я использую?*
- Web application with server backend — Authorization code flow
- Native mobile app — Authorization code flow with PKCE
- Javascript app (SPA) with third-party API backend — Implicit flow
- Microservices and APIs — Client credentials flow
