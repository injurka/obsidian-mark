В этом разделе мы поговорим о том, как протокол `WebRTC` реализован в `JavaScript API`. Это не подробный обзор, а всего лишь попытка нарисовать общую картину того, что происходит в процессе коммуникации в реальном времени.

**new RTCPeerConnection**

`RTCPeerConnection` - "WebRTC-сессия" верхнего уровня. Она объединяет все упомянутые выше протоколы. Выполняется подготовка всех необходимых подсистем, но пока еще ничего не происходит.

**addTrack**

`addTrack` создает новый поток данных (stream) `RTP`. Для этого потока генерируется случайный источник синхронизации (Synchronization Source, `SSRC`). Поток находится внутри описания сессии (Session Description, `SDP`) (в медиаразделе), генерируемого `createOffer`. Каждый вызов `addTrack` создает новый `SSRC` и медиараздел.

После установки `SRTP-сессии` и шифрования, эти медиапакеты начинают передаваться через `ICE`.

**createDataChannel**

`createDataChannel` создает новый `SCTP-поток` при его отсутствии. По умолчанию `SCTP` отключен, он включается только при запросе любой стороной канала передачи данных.

После установки `DTLS-сессии` и шифрования, эти пакеты с данными начинают передаваться через `ICE`.

**createOffer**

`createOffer` генерирует описание локального состояния (local state) сессии, передаваемого удаленному (в значении "находящемуся далеко", remote) пиру.

Вызов `createOffer` ничего не меняет для локального пира.

**setLocalDescription**

`setLocalDescription` фиксирует (commits) запрошенные (произведенные) изменения. `addTrack`, `createDataChannel` и аналогичные вызовы являются временными до вызова `setLocalDescription`. `setLocalDescription` вызывается со значением, сгенерированным `createOffer`.

**setRemoteDescription**

`setRemoteDescription` – способ информирования локального агента о состоянии удаленных кандидатов. Это сигнализация, выполняемая `JavaScript API`.

После вызова `setRemoteDescription` обеими сторонами, агенты `WebRTC` имеют достаточно информации для начала коммуникации `P2P` (Peer-To-Peer - равный к равному).

**addIceCandidate**

`addIceCandidate` позволяет `WebRTC-агенту` добавлять дополнительных кандидатов `ICE` в любое время. Данный интерфейс отправляет кандидата `ICE` прямо в подсистему `ICE` и не оказывает никакого другого влияния на общее соединение.

**ontrack**

`ontrack` - это функция обратного вызова (callback), которая вызывается при получении `RTP-пакета` от удаленного пира. Входящие пакеты помещаются в описание сессии, которое передается в `setRemoteDescription`.

**oniceconnectionstatechange**

`oniceconnectionstatechange` - это колбэк, который вызывается при изменении состояния агента `ICE`. Так мы получаем уведомления об установке и завершении соединения.

**onconnectionstatechange**

`onconnectionstatechange` - это комбинация состояния `ICE` и `DTLS`. Мы можем использовать этот коллбэк для получения уведомления об успешной установке `ICE` и `DTLS`.