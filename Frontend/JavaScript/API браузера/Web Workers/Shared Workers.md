Общий рабочий поток, или общий поток, ведет себя как выделенный рабочий поток, но доступен через несколько доверенных контекстов выполнения. Например, две разные вкладки в одном источнике смогут получить доступ к одному рабочему потоку. `SharedWorker` и `Worker` имеют несколько разные интерфейсы обмена сообщениями, как внешние, так и внутренние.

Общий рабочий поток полезен в ситуациях, когда разработчик желает уменьшить вычислительные затраты, позволяя нескольким контекстам выполнения совместно использовать поток. Примером этого может быть один общий рабочий, управляющий веб-сокетом для отправки и получения сообщений для нескольких страниц одного и того же происхождения. Совместно используемые рабочие потоки также полезны, когда контексты одного и того же происхождения хотят общаться через совместно используемый поток.

## Использование объекта SharedWorker

Объект `SharedWorker`, возвращаемый конструктором `SharedWorker()`, используется в качестве единой точки связи с вновь созданным выделенным рабочим потоком. Он может использоваться для передачи информации между потоком и родительским контекстом через `MessagePort`, а также для отслеживания событий `error`, отправляемых выделенным потоком.

Объект `SharedWorker` поддерживает следующие свойства:

- **onerror** — может быть назначен обработчик событий, который будет вызываться всякий раз, когда `ErrorEvent` типа `error` всплывает от рабочего потока.
  - Это событие происходит, когда в рабочем потоке возникает ошибка.
  - Это событие также можно обработать с помощью `sharedWorker.addEventListener('error', handler)`.

- **port** — выделенный `MessagePort` для связи с общим рабочим потоком.


## Основные аспекты работы

1. **Создание и запуск**:
   - Shared Worker создается с помощью конструктора `SharedWorker`, которому передается путь к JavaScript-файлу, содержащему код воркера.
```javascript
const worker = new SharedWorker('worker.js');
```

2. **Общение с основным потоком**:
   - Воркер и основной поток могут обмениваться сообщениями с помощью методов `postMessage` и обработчика `onmessage`.
   - Основной поток:
 ```javascript
 worker.port.start(); // Необходимо вызвать start() для инициализации порта
 worker.port.postMessage('Hello from main thread');
 worker.port.onmessage = function(event) {
   console.log('Message from worker:', event.data);
 };
 ```
   - Воркер:
 ```javascript
 self.onconnect = function(event) {
   const port = event.ports[0];
   port.onmessage = function(event) {
	 console.log('Message from main thread:', event.data);
	 port.postMessage('Hello from worker');
   };
 };
 ```

3. **Область видимости**:
   - Shared Worker имеет свою собственную изолированную область видимости, что означает, что он не имеет доступа к переменным и функциям основного потока.

4. **Ограничения**:
   - Воркеры не имеют доступа к DOM, поэтому они не могут манипулировать элементами страницы напрямую.
   - Они также не могут использовать некоторые функции и объекты, такие как `alert`, `confirm`, и `prompt`.

5. **Использование**:
   - Shared Worker обычно используется для выполнения ресурсоемких вычислений, обработки данных, сетевых запросов и других задач, которые могут заблокировать основной поток и привести к зависанию пользовательского интерфейса.
   - Особенно полезны в приложениях, где несколько вкладок или iframe должны совместно использовать одни и те же данные или логику.

6. **Завершение работы**:
   - Shared Worker может быть остановлен из основного потока или из самого воркера.
   - Основной поток:
 ```javascript
 worker.port.postMessage('close');
 ```
   - Воркер:
 ```javascript
 self.onconnect = function(event) {
   const port = event.ports[0];
   port.onmessage = function(event) {
	 if (event.data === 'close') {
	   self.close();
	 }
   };
 };
 ```

![[./_/shared-workers.png]]

### Пример использования

**main.js**
```javascript
const worker = new SharedWorker('worker.js');
worker.port.start();

worker.port.postMessage({ action: 'calculate', data: [1, 2, 3, 4, 5] });

worker.port.onmessage = function(event) {
  console.log('Result from worker:', event.data);
};
```

**worker.js**
```javascript
self.onconnect = function(event) {
  const port = event.ports[0];

  port.onmessage = function(event) {
    if (event.data.action === 'calculate') {
      const result = event.data.data.reduce((acc, val) => acc + val, 0);
      port.postMessage(result);
    }
  };
};
```

## SharedWorkerGlobalScope

Внутри общего потока глобальная область является экземпляром `SharedWorkerGlobalScope`. Он наследуется от `WorkerGlobalScope` и, следовательно, включает в себя все его свойства и методы. Как и в случае с выделенными потоками, общий рабочий поток может получить доступ к этой глобальной области действия через `self`.

`SharedWorkerGlobalScope` расширяет `WorkerGlobalScope` следующими свойствами и методами:

- **name** — необязательный идентификатор строки, который может быть предоставлен конструктору `SharedWorker`.
- **importScripts()** — используется для импорта произвольного количества сценариев в рабочий поток.
- **close()** — аналог `worker.terminate()`. Он используется для немедленного завершения рабочего потока. Потоку не предоставляется никакой возможности для очистки; сценарий внезапно завершается.
- **onconnect** — должен быть установлен в качестве обработчика, когда устанавливается новое подключение к общему рабочему потоку. События `connect` включают в себя массив `ports` экземпляров `MessagePort`, который можно использовать для отправки сообщений обратно в родительский контекст.
  - Событие `connect` наступает, когда с общим потоком устанавливается соединение через `worker.port.onmessage` или `worker.port.start()`.
  - Это событие также может быть обработано с использованием `sharedWorker.addEventListener('connect', handler)`.

> [!WARN] Примечание
> В зависимости от реализации браузера вывод в `console` внутри `SharedWorker` может не происходить в представлении консоли браузера по умолчанию.

## Совместимость

<iframe src="https://caniuse.bitsofco.de/embed/index.html?feat=sharedworkers" frameborder="0" width="100%" height="510px"></iframe>