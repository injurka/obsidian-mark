Это средство регистрации колбэков, которые выполняются при уничтожении объектов, на которые больше нет сильных ссылок. Это позволяет освобождать связанные с объектом ресурсы или выполнять другие необходимые операции перед удалением объекта из памяти.

**Колбэк очистки (финализатор)** – это функция, которая выполняется в случае, если объект, зарегистрированный в `FinalizationRegistry`, удаляется из памяти сборщиком мусора.

Его цель – предоставить возможность выполнения дополнительных операций, связанных с объектом, после его окончательного удаления из памяти.

**Реестр** (или `FinalizationRegistry`) – это специальный объект в JavaScript, который управляет регистрацией и отменой регистрации объектов и их колбэков очистки.

Этот механизм позволяет зарегистрировать объект для отслеживания и связать с ним колбэк очистки. По сути, это структура, которая хранит информацию о зарегистрированных объектах и их колбэках очистки, а затем автоматически вызывает эти колбэки при удалении объектов из памяти.

Для создания экземпляра реестра `FinalizationRegistry`, необходимо вызвать его конструктор, который принимает единственный аргумент – колбэк очистки (финализатор).

Синтаксис:

```javascript
function cleanupCallback(heldValue) {
  // код колбэка очистки
}

const registry = new FinalizationRegistry(cleanupCallback);
```

Здесь:

- `cleanupCallback` – колбэк очистки, который будет автоматически вызван при удалении зарегистрированного объекта из памяти.
- `heldValue` – значение, которое передаётся в качестве аргумента для колбэка очистки. Если `heldValue` является объектом, реестр сохраняет на него сильную ссылку.
- `registry` – экземпляр `FinalizationRegistry`.

Методы `FinalizationRegistry`:

- `register(target, heldValue [, unregisterToken])` – используется для регистрации объектов в реестре.
    
    >`target` – регистрируемый для отслеживания объект. Если `target` будет удалён сборщиком мусора, колбэк очистки будет вызван с `heldValue` в качестве аргумента.
    
    >Опциональный `unregisterToken` – токен отмены регистрации. Может быть передан для отмены регистрации до удаления объекта сборщиком мусора. Обычно в качестве `unregisterToken` используется объект `target`, что является стандартной практикой.
    
- `unregister(unregisterToken)` – метод `unregister` используется для отмены регистрации объекта в реестре. Он принимает один аргумент – `unregisterToken` (токен отмены регистрации, который был получен при регистрации объекта).
    

Теперь перейдём к простому примеру. Воспользуемся уже известным нам объектом `user` и создадим экземпляр `FinalizationRegistry`:

```javascript
let user = { name: "John" };

const registry = new FinalizationRegistry((heldValue) => {
  console.log(`${heldValue} был собран сборщиком мусора.`);
});
```

Затем зарегистрируем объект, для которого требуется колбэк очистки, вызвав метод `register`:

```javascript
registry.register(user, user.name);
```

Реестр не хранит сильную ссылку на регистрируемый объект, так как это бы противоречило его предназначению. Если бы реестр сохранял сильную ссылку, то объект никогда бы не был очищен сборщиком мусора.

Если же объект удаляется сборщиком мусора, наш колбэк очистки может быть вызван в какой-то момент в будущем, с переданным ему `heldValue`:

```javascript
// Когда объект user удалится сборщиком мусора, в консоль будет выведено сообщение:
"John был собран сборщиком мусора."
```

Также существуют ситуации, когда даже в реализациях, где используется колбэк очистки, есть вероятность, что он не будет вызван.

Например:

- Когда программа полностью завершает свою работу (например, при закрытии вкладки в браузере).
- Когда сам экземпляр `FinalizationRegistry` больше не доступен для JavaScript кода. Если объект, создающий экземпляр `FinalizationRegistry`, выходит из области видимости или удаляется, то колбэки очистки, зарегистрированные в этом реестре, также могут быть не вызваны.

---
## Источники
- #### [learn.javascript](https://learn.javascript.ru/weakref-finalizationregistry)
